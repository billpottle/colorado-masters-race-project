<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sources ‚Ä¢ Colorado Masters Race Project</title>
    <link rel="icon" type="image/svg+xml" href="runner-favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <div class="theme-toggle" aria-label="Theme selector">
      <div class="segmented" role="tablist" aria-label="Theme">
        <button id="theme-dark" class="seg-btn active" role="tab" aria-selected="true" type="button">üåô Dark</button>
        <button id="theme-light" class="seg-btn" role="tab" aria-selected="false" type="button">‚òÄÔ∏è Light</button>
      </div>
    </div>
    <header>
      <h1 class="title">Data Sources</h1>
      <p class="subtitle">Where our race data comes from. We will be adding more sources as the project progresses.</p>
      <div class="header-actions">
        <a class="button" href="index.html" aria-label="Back to main">‚Üê Back to main</a>
      </div>
    </header>

    <main>
      <section class="card" aria-labelledby="sources-title">
        <div class="card-content">
          <h2 id="sources-title" class="section-title"><span class="dot"></span>Sources</h2>
          <div class="grid" role="list">
            <div class="link-card" role="listitem" aria-label="Boulder Road Runners results">
              <div class="card-header-with-logo">
                <img src="img/logo-BRR.png" alt="Boulder Road Runners Logo" class="source-logo">
                <div class="card-title-section">
                  <h3>Boulder Road Runners</h3>
                  <p>All-Comers Summer Track & Field Meet results across years, plus Mile High Mile races.</p>
                </div>
              </div>
              <div class="card-actions">
                <a class="button" href="https://boulderroadrunners.org/race-results/track-meets/" target="_blank" rel="noopener noreferrer">Visit site</a>
                <button id="brr-races-btn" class="button" type="button">Meets</button>
              </div>
            </div>
            
            <div class="link-card" role="listitem" aria-label="Fort Collins Running Club results">
              <div class="card-header-with-logo">
                <img src="img/FCRC-Logo-Full.webp" alt="Fort Collins Running Club Logo" class="source-logo">
                <div class="card-title-section">
                  <h3>Fort Collins Running Club</h3>
                  <p>NoCo All Comers Track Meet Series at Loveland High School.</p>
                </div>
              </div>
              <div class="card-actions">
                <a class="button" href="https://fortcollinsrunningclub.org/noco-all-comers-track-meets/" target="_blank" rel="noopener noreferrer">Visit site</a>
                <button id="fcrc-races-btn" class="button" type="button">Meets</button>
              </div>
            </div>
            
            <div class="link-card" role="listitem" aria-label="Colorado Senior Games results">
              <div class="card-header-with-logo">
                <img src="img/CO-Senior-Games-No-Year.svg" alt="Colorado Senior Games Logo" class="source-logo">
                <div class="card-title-section">
                  <h3>Colorado Senior Games</h3>
                  <p>Track and Field competition for athletes 50+ at Garry Berry Stadium in Colorado Springs.</p>
                </div>
              </div>
              <div class="card-actions">
                <a class="button" href="https://coloradoseniorgames.org/sport/track-and-field/" target="_blank" rel="noopener noreferrer">Visit site</a>
                <button id="csg-races-btn" class="button" type="button">Meets</button>
              </div>
            </div>
            
            <div class="link-card" role="listitem" aria-label="Western Colorado Senior Games results">
              <div class="card-header-with-logo">
                <img src="img/WesternCOSrGames.png" alt="Western Colorado Senior Games Logo" class="source-logo">
                <div class="card-title-section">
                  <h3>Western Colorado Senior Games</h3>
                  <p>Track and Field competition for athletes 50+.</p>
                </div>
              </div>
              <div class="card-actions">
                <button id="wcsg-races-btn" class="button" type="button">Meets</button>
              </div>
            </div>
            
            <div class="link-card" role="listitem" aria-label="Rocky Mountain State Games results">
              <div class="card-header-with-logo">
                <img src="img/RMSG-Transparent.png.webp" alt="Rocky Mountain State Games Logo" class="source-logo">
                <div class="card-title-section">
                  <h3>Rocky Mountain State Games</h3>
                  <p>Track and Field competition in Colorado Springs.</p>
                </div>
              </div>
              <div class="card-actions">
                <button id="rmsg-races-btn" class="button" type="button">Meets</button>
              </div>
            </div>
            <div class="link-card">
              <div class="card-header-with-logo">
                <img src="img/denver-athletics.webp" alt="Denver Athletics" class="source-logo">
                <div class="card-title-section">
                  <h3>Denver Athletics</h3>
                  <p>Track and Field meets in the Denver area.</p>
                </div>
              </div>
              <div class="card-actions">
                <button id="da-races-btn" class="button" type="button">Meets</button>
              </div>
            </div>
            <!-- Add more source cards here as new sources are integrated -->
          </div>
        </div>
      </section>

      <section id="races-card" class="card hidden" aria-labelledby="races-title" style="margin-top: 20px;">
        <div class="card-content">
          <h2 id="races-title" class="section-title" style="margin: 0;"><span class="dot"></span>Races</h2>
          <div id="races-summary" class="subtitle" style="margin-top: 6px;"></div>
          <div id="races-output" class="table-container" style="margin-top: 12px;">          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="disclaimers-title" style="margin-top: 20px;">
        <div class="card-content">
          <h2 id="disclaimers-title" class="section-title"><span class="dot"></span>Disclaimers</h2>
          <div class="disclaimer-list">
            <div class="disclaimer-item">
              <div class="disclaimer-icon">‚ö†Ô∏è</div>
              <div class="disclaimer-content">
                <strong>Mixed Gender Divisions:</strong> A few events have 'mixed' divisions where gender was a best guess based on name. We are happy to correct any issues.
              </div>
            </div>
            <div class="disclaimer-item">
              <div class="disclaimer-icon">üìÖ</div>
              <div class="disclaimer-content">
                <strong>January 1st Dates:</strong> If a performance is listed as occurring on January 1st, that means only the year of the event was available.
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
      // Minimal theme sync (reuse same keys as main)
      const themeDark = document.getElementById('theme-dark');
      const themeLight = document.getElementById('theme-light');
      function applyTheme(theme) {
        const root = document.documentElement;
        if (theme === 'light') {
          root.setAttribute('data-theme', 'light');
          themeLight && themeLight.classList.add('active');
          themeDark && themeDark.classList.remove('active');
        } else {
          root.removeAttribute('data-theme');
          themeDark && themeDark.classList.add('active');
          themeLight && themeLight.classList.remove('active');
        }
      }
      const stored = localStorage.getItem('cmrp-theme') || 'dark';
      applyTheme(stored);
      themeDark && themeDark.addEventListener('click', () => { localStorage.setItem('cmrp-theme','dark'); applyTheme('dark'); });
      themeLight && themeLight.addEventListener('click', () => { localStorage.setItem('cmrp-theme','light'); applyTheme('light'); });

      // Races listing
      const racesBtn = document.getElementById('brr-races-btn');
      const racesCard = document.getElementById('races-card');
      const racesOutput = document.getElementById('races-output');
      const racesSummary = document.getElementById('races-summary');

      let loadedRows = null;

      const MONTHS = { jan:0, feb:1, mar:2, apr:3, may:4, jun:5, jul:6, aug:7, sep:8, oct:9, nov:10, dec:11 };
      function toTwoDigitYear(y) {
        const num = Number(y);
        if (num < 100) {
          // For 2-digit years, assume 19xx for years 50-99 and 20xx for years 00-49
          // This handles Colorado Senior Games data from 1990s properly
          return num >= 50 ? (1900 + num) : (2000 + num);
        }
        return num;
      }
      function parseDateFlexible(input) {
        if (!input || typeof input !== 'string') return null;
        const raw = input.trim();
        if (raw.includes('-')) {
          const parts = raw.split('-');
          if (parts.length === 3) {
            const [d, m, y] = parts;
            const day = Number(d);
            const mon = MONTHS[m.toLowerCase().slice(0,3)];
            const year = toTwoDigitYear(y);
            if (!Number.isNaN(day) && mon >= 0 && !Number.isNaN(year)) {
              return new Date(year, mon, day);
            }
          }
        }
        if (raw.includes('/')) {
          const [mm, dd, yy] = raw.split('/').map(s => s.trim());
          const month = Number(mm) - 1;
          const day = Number(dd);
          const year = toTwoDigitYear(yy);
          if (!Number.isNaN(month) && !Number.isNaN(day) && !Number.isNaN(year)) {
            return new Date(year, month, day);
          }
        }
        const parsed = new Date(raw);
        return isNaN(parsed.getTime()) ? null : parsed;
      }
      function formatDate(date) {
        if (!date) return '‚Äî';
        const fmt = new Intl.DateTimeFormat(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
        return fmt.format(date);
      }
      function raceKey(dateStr, meetName) {
        const date = parseDateFlexible(dateStr);
        const name = (meetName || '').trim();
        if (!date || !name) return null;
        const key = [date.getFullYear(), String(date.getMonth()+1).padStart(2,'0'), String(date.getDate()).padStart(2,'0')].join('-');
        return key + '::' + name.toLowerCase();
      }

      async function ensureCsvLoaded() {
        if (loadedRows) return loadedRows;
        const resp = await fetch('outdoor-track-data.csv', { cache: 'no-store' });
        if (!resp.ok) throw new Error('Failed to load CSV');
        const text = await resp.text();
        const result = Papa.parse(text, { header: true, skipEmptyLines: true });
        loadedRows = result.data || [];
        return loadedRows;
      }

      function renderRacesTable(rows, title) {
        racesCard.classList.remove('hidden');
        racesSummary.textContent = `${rows.length.toLocaleString()} meet${rows.length === 1 ? '' : 's'} found` + (title ? ` for ${title}` : '');
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        ['Meet Name', 'Date', 'Results', 'Events'].forEach(h => {
          const th = document.createElement('th'); th.textContent = h; trh.appendChild(th);
        });
        thead.appendChild(trh); table.appendChild(thead);
        const tbody = document.createElement('tbody');
                for (const r of rows) {
          const tr = document.createElement('tr');
          const tdMeetName = document.createElement('td'); tdMeetName.textContent = r.meetName;
          const tdDate = document.createElement('td'); tdDate.textContent = formatDate(r.date);
          const tdCnt = document.createElement('td'); tdCnt.textContent = r.count.toLocaleString();
          const tdEvents = document.createElement('td'); tdEvents.textContent = Array.from(r.events).sort().join(', ');
          tr.appendChild(tdMeetName); tr.appendChild(tdDate); tr.appendChild(tdCnt); tr.appendChild(tdEvents);
          tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        racesOutput.innerHTML = '';
        racesOutput.appendChild(table);
        racesCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      async function listBrrRaces() {
        const rows = await ensureCsvLoaded();
        // Filter by BRR source
        const filtered = rows.filter(r => String(r['Source'] || '').trim() === 'BRR');
        const byRace = new Map();
        for (const r of filtered) {
          const meetName = (r['Meet name'] || '').trim();
          const date = parseDateFlexible(r['Date']);
          if (!meetName || !date) continue;
          
          const key = `${meetName}::${date.toISOString().split('T')[0]}`;
          if (!byRace.has(key)) {
            byRace.set(key, { 
              meetName: meetName, 
              date: date, 
              count: 0, 
              events: new Set()
            });
          }
          const agg = byRace.get(key);
          agg.count += 1;
          const event = (r['Event'] || '').trim();
          if (event) {
            agg.events.add(event);
          }
        }
        const list = Array.from(byRace.values()).sort((a,b) => (b.date?.getTime()||0) - (a.date?.getTime()||0));
        renderRacesTable(list, 'Boulder Road Runners');
      }

      async function listFcrcRaces() {
        const rows = await ensureCsvLoaded();
        // Filter by FCTC source
        const filtered = rows.filter(r => String(r['Source'] || '').trim() === 'FCTC');
        const byRace = new Map();
        for (const r of filtered) {
          const meetName = (r['Meet name'] || '').trim();
          const date = parseDateFlexible(r['Date']);
          if (!meetName || !date) continue;
          
          const key = `${meetName}::${date.toISOString().split('T')[0]}`;
          if (!byRace.has(key)) {
            byRace.set(key, { 
              meetName: meetName, 
              date: date, 
              count: 0, 
              events: new Set()
            });
          }
          const agg = byRace.get(key);
          agg.count += 1;
          const event = (r['Event'] || '').trim();
          if (event) {
            agg.events.add(event);
          }
        }
        const list = Array.from(byRace.values()).sort((a,b) => (b.date?.getTime()||0) - (a.date?.getTime()||0));
        renderRacesTable(list, 'Fort Collins Running Club');
      }

      async function listCsgRaces() {
        const rows = await ensureCsvLoaded();
        // Filter by CSG source
        const filtered = rows.filter(r => String(r['Source'] || '').trim() === 'CSG');
        const byRace = new Map();
        for (const r of filtered) {
          const meetName = (r['Meet name'] || '').trim();
          const date = parseDateFlexible(r['Date']);
          if (!meetName || !date) continue;
          
          const key = `${meetName}::${date.toISOString().split('T')[0]}`;
          if (!byRace.has(key)) {
            byRace.set(key, { 
              meetName: meetName, 
              date: date, 
              count: 0, 
              events: new Set()
            });
          }
          const agg = byRace.get(key);
          agg.count += 1;
          const event = (r['Event'] || '').trim();
          if (event) {
            agg.events.add(event);
          }
        }
        const list = Array.from(byRace.values()).sort((a,b) => (b.date?.getTime()||0) - (a.date?.getTime()||0));
        renderRacesTable(list, 'Colorado Senior Games');
      }

      async function listWcsgRaces() {
        const rows = await ensureCsvLoaded();
        // Filter by WCSG source
        const filtered = rows.filter(r => String(r['Source'] || '').trim() === 'WCSG');
        const byRace = new Map();
        for (const r of filtered) {
          const meetName = (r['Meet name'] || '').trim();
          const date = parseDateFlexible(r['Date']);
          if (!meetName || !date) continue;
          
          const key = `${meetName}::${date.toISOString().split('T')[0]}`;
          if (!byRace.has(key)) {
            byRace.set(key, { 
              meetName: meetName, 
              date: date, 
              count: 0, 
              events: new Set()
            });
          }
          const agg = byRace.get(key);
          agg.count += 1;
          const event = (r['Event'] || '').trim();
          if (event) {
            agg.events.add(event);
          }
        }
        const list = Array.from(byRace.values()).sort((a,b) => (b.date?.getTime()||0) - (a.date?.getTime()||0));
        renderRacesTable(list, 'Western Colorado Senior Games');
      }

      async function listDaRaces() {
        const rows = await ensureCsvLoaded();
        // Filter by DA source
        const filtered = rows.filter(r => String(r['Source'] || '').trim() === 'DA');
        const byRace = new Map();
        for (const r of filtered) {
          const meetName = (r['Meet name'] || '').trim();
          const date = parseDateFlexible(r['Date']);
          if (!meetName || !date) continue;
          
          const key = `${meetName}::${date.toISOString().split('T')[0]}`;
          if (!byRace.has(key)) {
            byRace.set(key, { 
              meetName: meetName, 
              date: date, 
              count: 0, 
              events: new Set()
            });
          }
          const agg = byRace.get(key);
          agg.count += 1;
          const event = (r['Event'] || '').trim();
          if (event) {
            agg.events.add(event);
          }
        }
        const list = Array.from(byRace.values()).sort((a,b) => (b.date?.getTime()||0) - (a.date?.getTime()||0));
        renderRacesTable(list, 'Denver Athletics');
      }

      async function listRmsgRaces() {
        const rows = await ensureCsvLoaded();
        // Filter by RMSG source
        const filtered = rows.filter(r => String(r['Source'] || '').trim() === 'RMSG');
        const byRace = new Map();
        for (const r of filtered) {
          const meetName = (r['Meet name'] || '').trim();
          const date = parseDateFlexible(r['Date']);
          if (!meetName || !date) continue;

          const key = `${meetName}::${date.toISOString().split('T')[0]}`;
          if (!byRace.has(key)) {
            byRace.set(key, {
              meetName: meetName,
              date: date,
              count: 0,
              events: new Set()
            });
          }
          const agg = byRace.get(key);
          agg.count += 1;
          const event = (r['Event'] || '').trim();
          if (event) {
            agg.events.add(event);
          }
        }
        const list = Array.from(byRace.values()).sort((a,b) => (b.date?.getTime()||0) - (a.date?.getTime()||0));
        renderRacesTable(list, 'Rocky Mountain State Games');
      }

      racesBtn && racesBtn.addEventListener('click', () => { listBrrRaces().catch(console.error); });
      
      const fcrcRacesBtn = document.getElementById('fcrc-races-btn');
      fcrcRacesBtn && fcrcRacesBtn.addEventListener('click', () => { listFcrcRaces().catch(console.error); });
      
      const csgRacesBtn = document.getElementById('csg-races-btn');
      csgRacesBtn && csgRacesBtn.addEventListener('click', () => { listCsgRaces().catch(console.error); });
      
      const wcsgRacesBtn = document.getElementById('wcsg-races-btn');
      wcsgRacesBtn && wcsgRacesBtn.addEventListener('click', () => { listWcsgRaces().catch(console.error); });
      
      const daRacesBtn = document.getElementById('da-races-btn');
      daRacesBtn && daRacesBtn.addEventListener('click', () => { listDaRaces().catch(console.error); });
      
      const rmsgRacesBtn = document.getElementById('rmsg-races-btn');
      rmsgRacesBtn && rmsgRacesBtn.addEventListener('click', () => { listRmsgRaces().catch(console.error); });
    </script>
  </body>
  </html>


