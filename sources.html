<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sources ‚Ä¢ Colorado Masters Race Project</title>
    <link rel="icon" type="image/svg+xml" href="runner-favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <div class="theme-toggle" aria-label="Theme selector">
      <div class="segmented" role="tablist" aria-label="Theme">
        <button id="theme-dark" class="seg-btn active" role="tab" aria-selected="true" type="button">üåô Dark</button>
        <button id="theme-light" class="seg-btn" role="tab" aria-selected="false" type="button">‚òÄÔ∏è Light</button>
      </div>
    </div>
    <header>
      <h1 class="title">Data Sources</h1>
      <p class="subtitle">Where our race data comes from. We will be adding more sources as the project progresses.</p>
      <div class="header-actions">
        <a class="button" href="index.html" aria-label="Back to main">‚Üê Back to main</a>
      </div>
    </header>

    <main>
      <section class="card" aria-labelledby="sources-title">
        <div class="card-content">
          <h2 id="sources-title" class="section-title"><span class="dot"></span>Sources</h2>
          <div class="control-row" style="margin: 8px 0 12px;">
            <label class="footer-note" for="filter-after" style="margin-right:6px;">After</label>
            <input id="filter-after" type="date" class="input" style="min-width: 0; width: 160px;" />
            <label class="footer-note" for="filter-before" style="margin: 0 6px 0 12px;">Before</label>
            <input id="filter-before" type="date" class="input" style="min-width: 0; width: 160px;" />
            <button id="view-all-btn" class="button" type="button" style="margin-left:auto;">View all races</button>
          </div>
          <div id="sources-grid" class="grid" role="list"></div>
        </div>
      </section>

      <section id="races-card" class="card hidden" aria-labelledby="races-title" style="margin-top: 20px;">
        <div class="card-content">
          <h2 id="races-title" class="section-title" style="margin: 0;"><span class="dot"></span>Races</h2>
          <div id="races-summary" class="subtitle" style="margin-top: 6px;"></div>
          <div id="races-output" class="table-container" style="margin-top: 12px;">          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="disclaimers-title" style="margin-top: 20px;">
        <div class="card-content">
          <h2 id="disclaimers-title" class="section-title"><span class="dot"></span>Disclaimers</h2>
          <div class="disclaimer-list">
            <div class="disclaimer-item">
              <div class="disclaimer-icon">‚ö†Ô∏è</div>
              <div class="disclaimer-content">
                <strong>Mixed Gender Divisions:</strong> A few events have 'mixed' divisions where gender was a best guess based on name. We are happy to correct any issues.
              </div>
            </div>
            <div class="disclaimer-item">
              <div class="disclaimer-icon">üìÖ</div>
              <div class="disclaimer-content">
                <strong>January 1st Dates:</strong> If a performance is listed as occurring on January 1st, that means only the year of the event was available.
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="sources.js"></script>
    <script>
      // Minimal theme sync (reuse same keys as main)
      const themeDark = document.getElementById('theme-dark');
      const themeLight = document.getElementById('theme-light');
      function applyTheme(theme) {
        const root = document.documentElement;
        if (theme === 'light') {
          root.setAttribute('data-theme', 'light');
          themeLight && themeLight.classList.add('active');
          themeDark && themeDark.classList.remove('active');
        } else {
          root.removeAttribute('data-theme');
          themeDark && themeDark.classList.add('active');
          themeLight && themeLight.classList.remove('active');
        }
      }
      const stored = localStorage.getItem('cmrp-theme') || 'dark';
      applyTheme(stored);
      themeDark && themeDark.addEventListener('click', () => { localStorage.setItem('cmrp-theme','dark'); applyTheme('dark'); });
      themeLight && themeLight.addEventListener('click', () => { localStorage.setItem('cmrp-theme','light'); applyTheme('light'); });

      // Races listing
      const racesBtn = null;
      const racesCard = document.getElementById('races-card');
      const racesOutput = document.getElementById('races-output');
      const racesSummary = document.getElementById('races-summary');

      let loadedRows = null;

      const MONTHS = { jan:0, feb:1, mar:2, apr:3, may:4, jun:5, jul:6, aug:7, sep:8, oct:9, nov:10, dec:11 };
      function toTwoDigitYear(y) {
        const num = Number(y);
        if (num < 100) {
          // For 2-digit years, assume 19xx for years 50-99 and 20xx for years 00-49
          // This handles Colorado Senior Games data from 1990s properly
          return num >= 50 ? (1900 + num) : (2000 + num);
        }
        return num;
      }
      function parseDateFlexible(input) {
        if (!input || typeof input !== 'string') return null;
        const raw = input.trim();
        if (raw.includes('-')) {
          const parts = raw.split('-');
          if (parts.length === 3) {
            const [d, m, y] = parts;
            const day = Number(d);
            const mon = MONTHS[m.toLowerCase().slice(0,3)];
            const year = toTwoDigitYear(y);
            if (!Number.isNaN(day) && mon >= 0 && !Number.isNaN(year)) {
              return new Date(year, mon, day);
            }
          }
        }
        if (raw.includes('/')) {
          const [mm, dd, yy] = raw.split('/').map(s => s.trim());
          const month = Number(mm) - 1;
          const day = Number(dd);
          const year = toTwoDigitYear(yy);
          if (!Number.isNaN(month) && !Number.isNaN(day) && !Number.isNaN(year)) {
            return new Date(year, month, day);
          }
        }
        const parsed = new Date(raw);
        return isNaN(parsed.getTime()) ? null : parsed;
      }
      function formatDate(date) {
        if (!date) return '‚Äî';
        if (date.getMonth() === 0 && date.getDate() === 1) {
          return String(date.getFullYear());
        }
        const fmt = new Intl.DateTimeFormat(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
        return fmt.format(date);
      }
      function raceKey(dateStr, meetName) {
        const date = parseDateFlexible(dateStr);
        const name = (meetName || '').trim();
        if (!date || !name) return null;
        const key = [date.getFullYear(), String(date.getMonth()+1).padStart(2,'0'), String(date.getDate()).padStart(2,'0')].join('-');
        return key + '::' + name.toLowerCase();
      }

      async function ensureCsvLoaded() {
        if (loadedRows) return loadedRows;
        const resp = await fetch('outdoor-track-data.csv', { cache: 'no-store' });
        if (!resp.ok) throw new Error('Failed to load CSV');
        const text = await resp.text();
        const result = Papa.parse(text, { header: true, skipEmptyLines: true });
        loadedRows = result.data || [];
        return loadedRows;
      }

      function getDateFilters() {
        const afterInput = document.getElementById('filter-after');
        const beforeInput = document.getElementById('filter-before');
        const afterVal = afterInput && afterInput.value ? new Date(afterInput.value + 'T00:00:00') : null;
        const beforeVal = beforeInput && beforeInput.value ? new Date(beforeInput.value + 'T23:59:59') : null;
        return { after: isNaN(afterVal?.getTime?.()) ? null : afterVal, before: isNaN(beforeVal?.getTime?.()) ? null : beforeVal };
      }

      function renderRacesTable(rows, title) {
        racesCard.classList.remove('hidden');
        racesSummary.textContent = `${rows.length.toLocaleString()} meet${rows.length === 1 ? '' : 's'} found` + (title ? ` for ${title}` : '');
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        ['Meet Name', 'Date', 'Results', 'Events'].forEach(h => {
          const th = document.createElement('th'); th.textContent = h; trh.appendChild(th);
        });
        thead.appendChild(trh); table.appendChild(thead);
        const tbody = document.createElement('tbody');
                for (const r of rows) {
          const tr = document.createElement('tr');
          const tdMeetName = document.createElement('td'); tdMeetName.textContent = r.meetName;
          const tdDate = document.createElement('td'); tdDate.textContent = formatDate(r.date);
          const tdCnt = document.createElement('td'); tdCnt.textContent = r.count.toLocaleString();
          const tdEvents = document.createElement('td'); tdEvents.textContent = Array.from(r.events).sort().join(', ');
          tr.appendChild(tdMeetName); tr.appendChild(tdDate); tr.appendChild(tdCnt); tr.appendChild(tdEvents);
          tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        racesOutput.innerHTML = '';
        racesOutput.appendChild(table);
        racesCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      async function listRacesForSource(code) {
        const rows = await ensureCsvLoaded();
        const src = String(code || '').trim();
        if (!src) return;
        const { after, before } = getDateFilters();
        const filtered = rows.filter(r => {
          if (String(r['Source'] || '').trim() !== src) return false;
          const d = parseDateFlexible(r['Date']);
          if (!d) return false;
          if (after && d < after) return false;
          if (before && d > before) return false;
          return true;
        });
        const byRace = new Map();
        for (const r of filtered) {
          const meetName = (r['Meet name'] || '').trim();
          const date = parseDateFlexible(r['Date']);
          if (!meetName || !date) continue;
          const key = `${meetName}::${date.toISOString().split('T')[0]}`;
          if (!byRace.has(key)) byRace.set(key, { meetName, date, count: 0, events: new Set() });
          const agg = byRace.get(key);
          agg.count += 1;
          const event = (r['Event'] || '').trim();
          if (event) agg.events.add(event);
        }
        const list = Array.from(byRace.values()).sort((a,b) => (b.date?.getTime()||0) - (a.date?.getTime()||0));
        const title = (window.SOURCES && window.SOURCES[src] && window.SOURCES[src].name) || src;
        renderRacesTable(list, title);
      }

      async function listAllRaces() {
        const rows = await ensureCsvLoaded();
        const { after, before } = getDateFilters();
        const byRace = new Map();
        for (const r of rows) {
          const meetName = (r['Meet name'] || '').trim();
          const date = parseDateFlexible(r['Date']);
          if (!meetName || !date) continue;
          if (after && date < after) continue;
          if (before && date > before) continue;
          const key = `${meetName}::${date.toISOString().split('T')[0]}`;
          if (!byRace.has(key)) byRace.set(key, { meetName, date, count: 0, events: new Set() });
          const agg = byRace.get(key);
          agg.count += 1;
          const event = (r['Event'] || '').trim();
          if (event) agg.events.add(event);
        }
        const list = Array.from(byRace.values()).sort((a,b) => (b.date?.getTime()||0) - (a.date?.getTime()||0));
        renderRacesTable(list, 'All sources');
      }

      function renderSourcesGrid() {
        const grid = document.getElementById('sources-grid');
        if (!grid || !window.SOURCES) return;
        grid.innerHTML = '';
        for (const [code, meta] of Object.entries(window.SOURCES)) {
          const card = document.createElement('div');
          card.className = 'link-card';
          card.setAttribute('role','listitem');
          const header = document.createElement('div'); header.className = 'card-header-with-logo';
          const img = document.createElement('img'); img.className = 'source-logo'; img.src = meta.logo; img.alt = `${meta.name} Logo`;
          const titleWrap = document.createElement('div'); titleWrap.className = 'card-title-section';
          const h3 = document.createElement('h3'); h3.textContent = meta.name;
          const p = document.createElement('p'); p.textContent = meta.description || '';
          titleWrap.appendChild(h3); if (p.textContent) titleWrap.appendChild(p);
          header.appendChild(img); header.appendChild(titleWrap); card.appendChild(header);
          const actions = document.createElement('div'); actions.className = 'card-actions';
          if (meta.url) {
            const a = document.createElement('a'); a.className = 'button'; a.href = meta.url; a.target = '_blank'; a.rel = 'noopener noreferrer'; a.textContent = 'Visit site'; actions.appendChild(a);
          }
          const btn = document.createElement('button'); btn.className = 'button'; btn.type = 'button'; btn.textContent = 'Meets';
          btn.addEventListener('click', () => { listRacesForSource(code).catch(console.error); });
          actions.appendChild(btn);
          card.appendChild(actions);
          grid.appendChild(card);
        }
      }

      renderSourcesGrid();
      const viewAllBtn = document.getElementById('view-all-btn');
      viewAllBtn && viewAllBtn.addEventListener('click', () => { listAllRaces().catch(console.error); });
    </script>
  </body>
  </html>


